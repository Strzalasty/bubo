<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detekcja d≈∫wiƒôku</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands"></script>
</head>
<body>
    <h1>Detekcja d≈∫wiƒôku</h1>
    <p id="status">≈Åadowanie modelu...</p>
    <button id="startBtn" onclick="startListening()">Start</button>
    <button id="stopBtn" onclick="stopListening()" disabled>Stop</button>

    <audio id="alarmSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>

    <script>
        let recognizer;
        let isListening = false; // Flaga, czy mikrofon jest aktywny

        async function loadModel() {
            const URL = "https://strzalasty.github.io/bubo/"; // ≈öcie≈ºka do modelu
            recognizer = speechCommands.create(
                "BROWSER_FFT",
                undefined,
                URL + "model.json",
                URL + "metadata.json"
            );
            await recognizer.ensureModelLoaded();
            document.getElementById("status").innerText = "Model za≈Çadowany. Naci≈õnij Start.";
        }

        async function startListening() {
            if (!recognizer) {
                console.error("Model nie zosta≈Ç za≈Çadowany!");
                return;
            }
            if (isListening) {
                console.warn("Nas≈Çuchiwanie ju≈º trwa!");
                return;
            }

            isListening = true;
            document.getElementById("startBtn").disabled = true;
            document.getElementById("stopBtn").disabled = false;

            recognizer.listen(result => {
                const labels = recognizer.wordLabels();
                const highestIndex = result.scores.indexOf(Math.max(...result.scores));
                const detectedLabel = labels[highestIndex];

                document.getElementById("status").innerText = `Wykryto: ${detectedLabel}`;

                if (detectedLabel === "Class 2") { // Je≈õli wykryto "Class 2"
                    playAlarm();
                    stopListening();
                }
            }, {
                probabilityThreshold: 0.75
            });
        }

        function stopListening() {
            if (!isListening) {
                console.warn("Nas≈Çuchiwanie nie jest aktywne!");
                return;
            }

            recognizer.stopListening();
            isListening = false;
            document.getElementById("status").innerText = "Nas≈Çuchiwanie zatrzymane. Naci≈õnij Start, aby wznowiƒá.";
            document.getElementById("startBtn").disabled = false;
            document.getElementById("stopBtn").disabled = true;
        }

        function playAlarm() {
            const alarm = document.getElementById("alarmSound");
            alarm.play();
            console.log("üö® Alarm zosta≈Ç uruchomiony!");
        }

        loadModel();
    </script>
</body>
</html>
